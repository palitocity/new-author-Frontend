(t=>{const{screen:{width:e,height:a},navigator:{language:r},location:i,document:n,history:o}=t,{hostname:s,href:c,origin:d}=i,{currentScript:l,referrer:u}=n,f=c.startsWith("data:")?void 0:t.localStorage;if(!l)return;if(t.dylami&&t.dylami.initialized)return;t.profitroomLayer||(t.profitroomLayer=[]);const m=l.getAttribute.bind(l),y=m("data-website"),p=m("data-page"),h=m("data-app")||"unknown",g=m("data-before-send"),b="true"===m("data-auto-track"),w=m("data-domains")||"",v=w.split(",").map((t=>t.trim())),L=`${new URL(l.src).origin}/send`,S=`${e}x${a}`,I=/data-dylami-event-([\w-_]+)/,T="data-dylami-event",N={},E=t.profitroomLayer.push;let k,A,O=!1,U=u.startsWith(d)?"":u,j=[],z=null,x=0;const R=t=>{if(t){try{const e=decodeURI(t);if(e!==t)return e}catch(e){return t}return encodeURI(t)}},K=t=>{try{const{pathname:e,search:a,hash:r}=new URL(t,i.href);t=e+a+r}catch(t){}return t},$=()=>({website:y,hostname:s,screen:S,language:r,app:h,page:p,url:R(A),referrer:R(U)}),_=()=>!y||f&&f.getItem("dylami.disabled")||w&&!v.includes(s),B=async(e,a="event")=>{if(_())return;const r=t[g];if("function"==typeof r&&(e=r(a,e)),!e)return;const i={"Content-Type":"application/json"};void 0!==k&&(i["x-dylami-cache"]=k);try{const t=await fetch(L,{keepalive:!0,method:"POST",body:JSON.stringify({type:a,payload:e}),headers:i,credentials:"omit"}),r=await t.text(),[n,o]=r.split("_");if(o)try{const t=JSON.parse(atob(o));N.userId=t.userId,O||(O=!0,j.forEach((t=>t(N))),j=[])}catch(t){}return k=n}catch(t){}},J=(t,e)=>B("string"==typeof t?{...$(),name:t,data:"object"==typeof e?e:void 0}:"object"==typeof t?t:"function"==typeof t?t($()):$()),P=(t,e,a)=>{a&&(U=A,A=K(a.toString()),A!==U&&(z&&clearTimeout(z),z=setTimeout(J,300)))},W=()=>{t.dylami.initialized||(J().catch(console.error),(()=>{const t=(t,e,a)=>{const r=t[e];return(...e)=>(a.apply(null,e),r.apply(t,e))};o.pushState=t(o,"pushState",P),o.replaceState=t(o,"replaceState",P)})(),n.addEventListener("click",(async t=>{const e=t=>["BUTTON","A"].includes(t),a=async t=>{const e=t.getAttribute.bind(t),a=e(T);if(a){const r={};return t.getAttributeNames().forEach((t=>{const a=t.match(I);a&&(r[a[1]]=e(t))})),J(a,r)}},r=t.target,n=e(r.tagName)?r:((t,a)=>{let r=t;for(let t=0;t<a;t++){if(e(r.tagName))return r;if(r=r.parentElement,!r)return null}})(r,10);if(!n)return a(r);{const{href:e,target:r}=n,o=n.getAttribute(T);if(o)if("A"===n.tagName){const s="_blank"===r||t.ctrlKey||t.shiftKey||t.metaKey||t.button&&1===t.button;if(o&&e)return s||t.preventDefault(),a(n).then((()=>{s||(i.href=e)}))}else if("BUTTON"===n.tagName)return a(n)}}),!0),t.dylami.initialized=!0)};t.dylami||(t.profitroomLayer.push=function(...e){e.forEach((t=>{"object"==typeof t&&t&&(t["dylami.messageId"]||(J((e=>({...e,...t}))),t["dylami.messageId"]=++x))}));const a=E.apply(this,e);for(;t.profitroomLayer.length>100;)t.profitroomLayer.shift();return a},t.dylami={track:J,initialized:!1,get(t,e=2e3){if(["userId"].includes(t))return new Promise((a=>{if(O)a(N[t]);else{let r=null;const i=setTimeout((()=>{if(r){const t=j.indexOf(r);-1!==t&&j.splice(t,1)}}),e);r=()=>{clearTimeout(i),a(N[t])},j.push(r)}}))}}),A=K(c),b&&!_()?"complete"===n.readyState?W():n.addEventListener("readystatechange",W,!0):t.dylami.initialized=!0,t.profitroomLayer.forEach((t=>{"object"==typeof t&&t&&(t["dylami.messageId"]||(J((e=>({...e,...t}))),t["dylami.messageId"]=++x))}))})(window);